10 ' BUSINESS CALCULATOR
20 ' Version 01.00.00
100 CLS

function ToPixelY(line) as integer
    ToPixelY = line * MM.FONTHEIGHT
end function
function ToPixelX(col) as integer
    ToPixelX = col * MM.FONTWIDTH
end function

280 GOSUB 40000

1000 ' Branch on next operation
1005 EF=0
1010 GOSUB 40050

1020 ON INSTR("+-*/^="+CHR$(10)+chr$(13),OP$) GOTO 2000,3000,4000,5000,6000,9000,9000,9000
2000 ' Addition
2010 GOSUB 10000
2020 A=A+N
2030 GOTO 1000
3000 ' Subtraction
3010 GOSUB 10000
3020 A=A-N
3030 GOTO 1000
4000 ' Multiplication
4010 GOSUB 10000
4020 A=A*N
4030 GOTO 1000
5000 ' Division
5010 GOSUB 10000
5020 IF EF=0 THEN A=A/N
5030 GOTO 1000
6000 ' Exponentiation
6010 GOSUB 10000
6020 A=A^N
6030 GOTO 1000
9000 ' ENTER or =
9010 GOSUB 10000
9020 IF LEN(N1$)>0 THEN A=A+N
9030 GOTO 1000

10000 ' Load a number and the next operand
10010 F=0
10020 PRINT @(0,ToPixelY(5)) TAB(39);
10030 PRINT @(0,ToPixelY(5)) ;
10040 IF OP$>"" AND INSTR("+-*/^",OP$)>0 THEN
         F=1
		 PRINT OP$;
	  ELSE
	     PRINT " ";
      endif
10050 N=0
10060 N1$=""
10070 PRINT ">_";CHR$(8);
10080 a1$=INKEY$: IF a1$="" THEN goto 10080

20000 ' Special key functions
select case asc(a1$)
    case 145
		' 1/X
		A=1/A: GOTO 40050
    case 146	   
		' -X
		A=-A: GOTO 40050
	case 147
		' SQR
		if a < 0 then goto 40050
		A=SQR(A): GOTO 40050
	case 148
		' X Squared
		A=A*A: GOTO 40050
	case 149
		' LOG
		A=LOG(A): GOTO 40050
	case 150
		' EXP
		A=EXP(A): GOTO 40050
	case 151
		gosub 30000
	case 152
		' Exit program
        CLS
		END
end select

10090 IF INSTR("0123456789.",a1$)>0 THEN N1$=N1$+a1$: F=0: PRINT a1$;"_";CHR$(8);: GOTO 10080
10100 IF a1$="-" AND F=1 THEN F=0: N1$=a1$: PRINT a1$;"_";CHR$(8);: GOTO 10080
10110 ON INSTR(CHR$(8)+CHR$(127)+CHR$(27),a1$) GOTO 10140,10180,10190
10120 IF INSTR("+-*/^="+CHR$(10)+chr$(13),a1$)=0 THEN goto 10080
10130 N=VAL(N1$): OP$=a1$: RETURN
10140 IF N1$="" THEN goto 10080
10150 PRINT CHR$(8);"_ ";STRING$(2,8);
10160 N1$=LEFT$(N1$,LEN(N1$)-1)
10170 GOTO 10080
10180 GOTO 10000
10190 EF=1: A=0: N1$="": a1$="": GOTO 10130


30000 ' Enter CALC mode
30020 CLS
30030 PRINT TAB(9);"CALCULATION FUNCTIONS"
30040 PRINT
30050 PRINT "(F1) Days & Dates      (F4) Bonds"
30060 PRINT "(F2) Interest          (F5) Futures"
30070 PRINT "(F3) Loans             (ESC) Exit"
30080 PRINT
30090 PRINT "Your choice? ";
30100 GOSUB 41030
30110 IF a1$=CHR$(27) THEN GOSUB 40000: a1$="": RETURN

select case ASC(a1$)
    case 145
	    goto 31000
	case 146
	    goto 32000
	case 147
		goto 33000
	case 148
		goto 34000
	case 149
		goto 35000
end select

30130 GOTO 30100
31000 ' Days and Dates routines
31010 CLS
31020 PRINT TAB(13);"DAYS AND DATES"
31030 PRINT
31040 PRINT TAB(5);"(F1) Find day of week"
31050 PRINT TAB(5);"(F2) Days between dates"
31060 PRINT TAB(5);"(F3) Date days hence/ago"
      PRINT TAB(5);"(ESC) Menu"
31070 PRINT
31080 PRINT "Your choice? ";
31090 GOSUB 41030
31100 IF a1$=CHR$(27) THEN goto 30000
31110 IF ASC(a1$)<145 OR ASC(a1$)>147 THEN goto 31090
31120 CLS

select case ASC(a1$)
    case 145
	    goto 31160
	case 146
	    goto 31220
	case 147
		goto 31320
end select

31140 GOTO 31000
31150 ' Find day of week
31160 PRINT "Enter";
31170 GOSUB 31430
31180 GOSUB 31610
31190 GOSUB 31760
31200 GOTO 31880
31210 ' Find days between dates
31220 PRINT "First";
31230 GOSUB 31430
31240 GOSUB 31610
31250 AA=J
31260 PRINT "Second";
31270 GOSUB 31430
31280 GOSUB 31610
31290 PRINT ABS(AA-J);" days between dates"
31300 GOTO 31880
31310 ' Find date days hence/ago
31320 PRINT "Reference";
31330 GOSUB 31430
31340 GOSUB 31610
31350 AA=J
31360 INPUT "Days hence (+)/ago (-)";B:print
31370 J=AA+B
31380 GOSUB 31650
'31390 PRINT MID$(STR$(M),2);"/";MID$(STR$(D),2);"/";MID$(STR$(Y),2);"  ";
31390 PRINT STR$(M);"/";STR$(D);"/";STR$(Y);"  ";
31400 GOSUB 31760
31410 GOTO 31880
31420 ' Fetch a date
31430 LINE INPUT " date? (mm/dd/yyyy) ";d1$:print
31440 IF LEN(d1$) <8 OR LEN(d1$) >10 THEN goto 31560
31450 M=VAL(LEFT$(d1$,2))
31460 E=2
31470 GOSUB 31590
31480 D=VAL(MID$(d1$,E+1,2))
31490 Y=VAL(RIGHT$(d1$,4))
31500 IF D<1 OR M<1 OR M>12 OR Y<1900 OR Y>2100 THEN goto 31560
31510 IF (M=4 OR M=6 OR M=9 OR M=11) AND D>30 THEN goto 31560
31520 IF M<>2 AND D>31 THEN goto 31560
31530 IF M=2 AND D>(28-(INT(Y/4)=(Y/4))) THEN goto 31560
31540 IF (Y=1900 AND M<3) OR (Y=2100 AND M>2) THEN goto 31560
31550 RETURN
31560 play tone 1000,1000,200
31570 PRINT "Bad input -- reenter";
31580 GOTO 31430
31590 IF MID$(d1$,E,1)<>"/" THEN E=E+1: GOTO 31590
31600 RETURN
31610 IF M<3 THEN M=M+12: Y=Y-1
31620 M=M+1
31630 J=INT(365.25*Y)+INT(30.6001*M)+D+1720982
31640 RETURN
31650 R=J+68569
31660 P=INT(4*R/146097)
31670 R=-INT((146097*P+3)/4)+R
31680 Y=INT(4000*(R+1)/1461001)
31690 R=-INT(1461*Y/4)+31+R
31700 M=INT(80*R/2447)
31710 D=-INT(2447*M/80)+R
31720 R=INT(M/11)
31730 M=-12*R+2+M
31740 Y=100*(P-49)+Y+R
31750 RETURN
31760 E=J+1-7*INT((J+1)/7)
31770 RESTORE
31780 FOR I=0 TO E: READ DW$: NEXT I
31790 PRINT DW$
31800 RETURN
31810 DATA "Sunday"
31820 DATA "Monday"
31830 DATA "Tuesday"
31840 DATA "Wednesday"
31850 DATA "Thursday"
31860 DATA "Friday"
31870 DATA "Saturday"
31880 PRINT
31890 GOSUB 41000
31900 GOTO 31010
32000 ' Interest formulas
32010 CLS
32020 PRINT TAB(12);"INTEREST FORMULAS"
32030 PRINT "Single payment:"
32040 PRINT " (F1) future worth    (F2) present worth";
32050 PRINT "Equal payment series:"
32060 PRINT " (F3) Future worth    (F4) Sinking fund
32070 PRINT " (F5) Cptl recovery   (F6) Present worth"
      PRINT
      PRINT "(ESC) Menu"
32080 PRINT
32090 PRINT "Your choice? ";
32100 GOSUB 41030
32110 IF a1$=CHR$(27) THEN goto 30000
32120 IF ASC(a1$)<145 OR ASC(a1$)>150 THEN goto 32100
32130 CLS

select case ASC(a1$)
    case 145
	    goto 32290
	case 146
	    goto 32310
	case 147
		goto 32330
	case 148
		goto 32350
	case 149
		goto 32370
	case 150
		goto 32390
end select

32150 GOTO 32000
32160 INPUT "Percent interest";I:print
32170 I=.01*I:INPUT "Number of periods";NN:print
32175 IF NN<1 THEN play tone 1000,1000,200: GOTO 32170
32180 RETURN
32190 INPUT "Present worth";P:print
32200 RETURN
32210 INPUT "Future worth";S:print
32220 RETURN
32230 INPUT "Payment";R:print
32240 RETURN
32250 X=P:GOSUB 42000:PRINT "Present worth is";x1$:GOTO 32400
32260 X=S:GOSUB 42000:PRINT "Future worth is";x1$:GOTO 32400
32270 X=R:GOSUB 42000:PRINT "Payment is";x1$:GOTO 32400
32280 ' Single payment future worth
32290 GOSUB 32190:GOSUB 32160:S=P*(I+1)^NN:GOTO 32260
32300 ' Single payment present worth
32310 GOSUB 32210:GOSUB 32160:P=S*(1/((I+1)^NN)):GOTO 32250
32320 ' EPS future worth
32330 GOSUB 32230:GOSUB 32160:S=R*((((I+1)^NN)-1)/I):GOTO 32260
32340 ' EPS sinking fund
32350 GOSUB 32210:GOSUB 32160:R=S*(I/(((I+1)^NN)-1)):GOTO 32270
32360 ' EPS capital recovery
32370 GOSUB 32190:GOSUB 32160:R=P*((I*((I+1)^NN))/((I+1)^NN-1)):GOTO 32270
32380 ' EPS present worth
32390 GOSUB 32230:GOSUB 32160:P=R*(((I+1)^NN)-1)/(I*(I+1)^NN):GOTO 32250
32400 PRINT
32410 GOSUB 41000
32420 GOTO 32000
33000 ' Loan calculations
33010 CLS
33020 PRINT TAB(12);"LOAN CALCULATIONS"
33030 PRINT
33040 PRINT "Find: (F1) Interest rate"
33050 PRINT TAB(7);"(F2) Payment"
33060 PRINT TAB(7);"(F3) Loan amount"
33070 PRINT TAB(7);"(F4) Number of pmts"
      PRINT TAB(7);"(ESC) Menu"
33080 PRINT
33090 PRINT "Your choice? ";
33100 GOSUB 41030
33110 IF a1$=CHR$(27) THEN goto 30000
33120 IF ASC(a1$)<145 OR ASC(a1$)>148 THEN goto 33100
33130 CLS

select case ASC(a1$)
    case 145
	    goto 33170
	case 146
	    goto 33340
	case 147
		goto 33420
	case 148
		goto 33500
end select

33150 GOTO 33000
33160 ' Find interest rate
33170 GOSUB 33570
33180 GOSUB 33590
33190 GOSUB 33610
33200 GOSUB 33670
33210 B=AA/P
33220 R=1/B-B/(NN*NN)
33230 IF R<=0 THEN goto 33760
33240 C=1-(1+R)^-NN
33250 D=R*B-C
33260 E=D/(C/R-(NN*(1+R)^(-NN-1)))
33270 R=R-E
33280 IF ABS(E)>=1E-7 THEN goto 33240
33290 I=R*M*100
33300 I=.01*INT(100*I+.5)
33310 PRINT "True rate is";I;CHR$(8);"%"
33320 GOTO 33690
33330 ' Find payment
33340 GOSUB 33570
33350 GOSUB 33630
33360 GOSUB 33610
33370 P=AA*R/(1-(1+R)^-NN)
33380 X=P: GOSUB 42000
33390 PRINT "Payment is";x1$
33400 GOTO 33690
33410 ' Find loan amount
33420 GOSUB 33590
33430 GOSUB 33630
33440 GOSUB 33610
33450 AA=P*(1-(1+R)^-NN)/R
33460 X=AA: GOSUB 42000
33470 PRINT "Loan amount is";x1$
33480 GOTO 33690
33490 ' Find number of payments
33500 GOSUB 33570
33510 GOSUB 33630
33520 GOSUB 33590
33530 IF AA*R/P>1 THEN goto 33760
33540 NN=-(LOG(1-AA*R/P))/(LOG(1+R))
33550 PRINT MID$(STR$(INT(NN-(NN<>INT(NN)))),2);" payments"
33560 GOTO 33690
33570 INPUT "Loan amount";AA:print
33580 RETURN
33590 INPUT "Payment";P:print
33600 RETURN
33610 INPUT "Number of payments";NN:print
33620 RETURN
33630 INPUT "True interest rate in %";I:print
33640 GOSUB 33670
33650 R=I/(M*100)
33660 RETURN
33670 INPUT "Periods per year";M:print
33680 RETURN
33690 S=.01*INT(100*P*NN+.5)
33700 T=S-AA
33710 X=S: GOSUB 42000
33720 PRINT "Sum of payments is";x1$
33730 X=T: GOSUB 42000
33740 PRINT "Sum of interest is";x1$
33750 GOTO 33780
33760 play tone 1000,1000,200
33770 PRINT "INVALID DATA"
33780 PRINT
33790 GOSUB 41000
33800 GOTO 33000
34000 ' Bond calculations
34010 CLS
34020 PRINT TAB(12);"BOND CALCULATIONS"
34030 PRINT
34040 PRINT TAB(5);"(F1) Find price"
34050 PRINT TAB(5);"(F2) Find yield"
      PRINT TAB(5);"(ESC) Menu"
34060 PRINT
34070 PRINT "Your choice? ";
34080 GOSUB 41030
34090 IF a1$=CHR$(27) THEN goto 30000
34100 IF ASC(a1$)<145 OR ASC(a1$)>146 THEN goto 34080
34110 CLS

select case ASC(a1$)
    case 145
	    goto 34150
	case 146
	    goto 34320
end select

34130 GOTO 34000
34140 ' Find bond price
34150 GOSUB 34470
34160 GOSUB 34450
34170 GOSUB 34430
34180 INPUT "Bond yield (%)";Y:print
34190 R=Y/100+1
34200 AA=M*R^-NN
34210 Z=0
34220 FOR J=1 TO NN
34230 T=R^-J
34240 Z=Z+T
34250 NEXT J
34260 P=I*Z+AA
34270 X=P: GOSUB 42000
34280 PRINT "Bond price is";x1$
34290 GOSUB 41000
34300 GOTO 34000
34310 ' Find bond yield
34320 INPUT "Bond price";P:print
34330 GOSUB 34470
34340 GOSUB 34450
34350 GOSUB 34430
34360 IF NN<>1 THEN goto 34490
34370 Y=((M+I)/P-1)*100
34380 X=Y
34390 GOSUB 34710
34400 PRINT "Bond yield is ";STR$(X);"%"
34410 GOSUB 41000
34420 GOTO 34000
34430 INPUT "Coupon value";I:print
34440 RETURN
34450 INPUT "Number of years";NN:print
34460 RETURN
34470 INPUT "Maturity value";M:print
34480 RETURN
34490 PRINT "Computing..."
34500 AA=1
34510 D=.5
34520 C=D
34530 E=C
34540 FOR J=1 TO NN-1
34550 E=(E+1)*C
34560 NEXT J
34570 F=C^NN*M+E*I
34580 X=F
34590 GOSUB 34710
34600 F=X
34610 IF F>=P THEN goto 34650
34620 D=C
34630 C=(C+AA)/2
34640 GOTO 34530
34650 IF F=P THEN goto 34690
34660 AA=C
34670 C=(C+D)/2
34680 GOTO 34530
34690 Y=(1/C-1)*100
34700 GOTO 34380
34710 X=.001*(INT(X*1000+.5))
34720 RETURN
35000 ' Future values
35010 CLS
35020 PRINT TAB(13);"FUTURE VALUES"
35030 PRINT
35040 PRINT TAB(5);"(F1) Find interest rate"
35050 PRINT TAB(5);"(F2) Find payment"
35060 PRINT TAB(5);"(F3) Find future value"
35070 PRINT TAB(5);"(F4) Find number of payments"
      PRINT TAB(5);"(ESC) Menu"
35080 PRINT
35090 PRINT "Your choice? ";
35100 GOSUB 41030
35110 IF a1$=CHR$(27) THEN goto 30000
35120 IF ASC(a1$)<145 OR ASC(a1$)>148 THEN goto 35100
35130 CLS

select case ASC(a1$)
    case 145
	    goto 35170
	case 146
	    goto 35340
	case 147
		goto 35420
	case 148
		goto 35500
end select

35150 GOTO 35000
35160 ' Find interest rate
35170 GOSUB 35560
35180 GOSUB 35580
35190 GOSUB 35600
35200 GOSUB 35750
35210 B=AA/P
35220 R=B/(NN*NN)-1/B
35230 IF R<0 THEN PRINT "INVALID DATA": play tone 1000,1000,200: GOTO 35720
35240 C=(1+R)^NN-1
35250 D=C-R*B
35260 E=D/(C/(-R)+NN*(1+R)^(NN-1))
35270 R=R-E
35280 IF ABS(E)>=1E-7 THEN goto 35240
35290 I=R*M*100
35300 I=.01*INT(100*I+.5)
35310 PRINT "True rate is ";STR$(I);"%"
35320 GOTO 35660
35330 ' Find payment
35340 GOSUB 35560
35350 GOSUB 35620
35360 GOSUB 35600
35370 P=AA*R/((1+R)^NN-1)
35380 X=P: GOSUB 42000
35390 PRINT "Payment is";x1$
35400 GOTO 35660
35410 ' Find future value
35420 GOSUB 35580
35430 GOSUB 35620
35440 GOSUB 35600
35450 AA=P*((1+R)^NN-1)/R
35460 X=AA: GOSUB 42000
35470 PRINT "Future value is";x1$
35480 GOTO 35660
35490 ' Find number of payments
35500 GOSUB 35560
35510 GOSUB 35620
35520 GOSUB 35580
35530 NN=(LOG(1+AA*R/P))/(LOG(1+R))
35540 PRINT MID$(STR$(INT(NN-(NN<>INT(NN)))),2);" payments"
35550 GOTO 35660
35560 INPUT "Future value";AA:print
35570 RETURN
35580 INPUT "Payment";P:print
35590 RETURN
35600 INPUT "Number of payments";NN:print
35610 RETURN
35620 INPUT "True interest rate in %";I:print
35630 GOSUB 35750
35640 R=I/(M*100)
35650 RETURN
35660 S=.01*INT(P*NN*100+.5)
35670 T=.01*INT((AA-S)*100+.5)
35680 X=S: GOSUB 42000
35690 PRINT "Sum of payments is";x1$
35700 X=T: GOSUB 42000
35710 PRINT "Sum of interest is";x1$
35720 PRINT
35730 GOSUB 41000
35740 GOTO 35000
35750 INPUT "Periods per year";M:print
35760 RETURN

40000 ' Construct screen
40010 CLS
40020 color rgb(black),rgb(green)
      PRINT " PicoCalc Business Calculator 01.00.01 ";
	  color rgb(green),rgb(black):print
40030 IF OP$="" THEN OP$="="
40040 PRINT @(0,ToPixelY(20));
      print "F1=1/X F2=-X   F3=Sqr  F4=X*X F5=Log"
      print "F6=e^x F7=Calc F8=Exit ESC=Clr Acc"
40050 PRINT @(0,ToPixelY(3)) string$(39,32);:'blank out line
      PRINT @(0,ToPixelY(3)) "Accum =";A
40060 PRINT @(0,ToPixelY(5));
40070 IF OP$>"" AND INSTR("+-*/^",OP$)>0 THEN
         F=1
		 PRINT OP$;
	  ELSE
	     PRINT " ";
      endif
40080 PRINT ">";
40090 IF N1$>"" THEN PRINT N1$;
40100 PRINT "_";CHR$(8);
40120 RETURN

41000 ' Await a keystroke
41010 PRINT "Press any key for menu ";
41030 a1$=INKEY$: IF a1$="" THEN goto 41030
41050 RETURN

42000 ' Format a quantity for display in dollar format
42010 X=.01*FIX(100*X+.5)
42020 x1$=MID$(STR$(X),2)
42030 IF INSTR(x1$,".")=LEN(x1$)-1 THEN x1$=x1$+"0"
42040 x1$=" $"+x1$
42050 RETURN
